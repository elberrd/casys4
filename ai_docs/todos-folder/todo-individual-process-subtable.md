# TODO: Individual Process Statuses Subtable Implementation

## Context

When creating a new Individual Process, we need to add a subtable that displays the status history for that process. The subtable should automatically insert a default "em_preparacao" status when a new individual process is created, and allow users to view/edit status dates.

## Related PRD Sections

- Section 10.4: Complete Convex Database Schema - individualProcessStatuses table
- Section 4.2: Core Tables Detailed - individual_processes
- Section 5.3: Status Tracking

## Current State Analysis

**Existing Schema (`individualProcessStatuses`):**

```typescript
{
  individualProcessId: v.id("individualProcesses"),
  statusName: v.string(), // DEPRECATED
  caseStatusId: v.optional(v.id("caseStatuses")), // NEW
  isActive: v.boolean(),
  notes: v.optional(v.string()),
  changedBy: v.id("users"),
  changedAt: v.number(),
  createdAt: v.number(),
}
```

**Required Changes:**

1. Add a "date" field to allow users to change the status date if needed
2. Remove the deprecated "statusName" field (keep for migration compatibility)
3. Ensure caseStatusId is required (not optional)
4. Auto-insert "em_preparacao" status when creating new individual process
5. Display subtable showing Case Status Name and the date

## Task Sequence

### 0. Project Structure Analysis

**Objective**: Understand the project structure and determine correct file/folder locations

#### Sub-tasks:

- [x] 0.1: Review `/ai_docs/prd.md` for project architecture and folder structure
  - Validation: Identified existing patterns for component placement, API routes, database schemas
  - Output: Documented relevant folder structure

- [x] 0.2: Identify where new files should be created based on PRD guidelines
  - Validation: New files follow established naming conventions and folder hierarchy
  - Output: File locations determined:
    - Schema updates: `/convex/schema.ts`
    - Backend mutations: `/convex/individualProcessStatuses.ts`
    - Backend queries: `/convex/individualProcesses.ts`
    - UI components: `/components/individual-processes/`
    - Form validations: `/lib/validations/individualProcesses.ts`
    - i18n translations: `/messages/en.json`, `/messages/pt.json`

- [x] 0.3: Check for existing similar implementations to maintain consistency
  - Validation: Reviewed existing code patterns
  - Output: Found existing status history component at `/components/individual-processes/status-history-timeline.tsx`

#### Quality Checklist:

- [x] PRD structure reviewed and understood
- [x] File locations determined and aligned with project conventions
- [x] Naming conventions identified and will be followed
- [x] Existing implementations reviewed for consistency

---

### 1. Update Database Schema

**Objective**: Modify the `individualProcessStatuses` schema to add date field and ensure proper structure

#### Sub-tasks:

- [x] 1.1: Update `individualProcessStatuses` schema in `/convex/schema.ts`
  - Add `date: v.optional(v.string())` field (ISO date format YYYY-MM-DD)
  - Keep `statusName` field marked as deprecated for migration compatibility
  - Change `caseStatusId` from `v.optional()` to required field
  - Update schema comments to reflect new requirements
  - Validation: Schema compiles without errors, proper indexes exist

- [x] 1.2: Add index for date queries if needed
  - Consider adding composite index for `by_individualProcess_date` if date filtering is needed
  - Validation: Schema validates correctly
  - Note: Date index not needed - using changedAt for chronological ordering

- [x] 1.3: Update TypeScript types to reflect schema changes
  - Ensure generated types in `convex/_generated/dataModel.d.ts` include new date field
  - Validation: Types compile correctly, no TypeScript errors
  - Note: Types auto-generated by Convex from schema

#### Quality Checklist:

- [x] TypeScript types defined (no `any`)
- [x] Schema field validations proper
- [x] Migration path considered (kept statusName field)
- [x] Indexes optimized for queries
- [x] Clean code principles followed

---

### 2. Update Backend Mutations and Queries

**Objective**: Update Convex functions to handle the new date field and default status creation

#### Sub-tasks:

- [x] 2.1: Update `individualProcesses.create` mutation in `/convex/individualProcesses.ts`
  - Add logic to find "em_preparacao" status by code using `caseStatuses.getByCode`
  - Insert initial status record with `date` set to current date (format: ISO YYYY-MM-DD)
  - Use `caseStatusId` from the "em_preparacao" case status
  - Set `changedAt` to current timestamp
  - Validation: New individual processes automatically get "em_preparacao" status with today's date

- [x] 2.2: Update `individualProcessStatuses.addStatus` mutation in `/convex/individualProcessStatuses.ts`
  - Add `date: v.optional(v.string())` to mutation args
  - Add `caseStatusId: v.id("caseStatuses")` as required parameter
  - Default date to current date if not provided
  - Update status insertion to include date field
  - Update backward compatibility logic
  - Validation: Status creation includes date, properly formatted

- [x] 2.3: Update `individualProcessStatuses.updateStatus` mutation
  - Add `date: v.optional(v.string())` to mutation args
  - Allow updating the date field
  - Add date format validation (YYYY-MM-DD)
  - Validation: Date can be updated correctly

- [x] 2.4: Update `individualProcessStatuses.getStatusHistory` query
  - Ensure returned data includes the `date` field
  - Enrich with full `caseStatus` object (name, nameEn, color, etc.)
  - Validation: Query returns complete status data including date
  - Note: Already enriches with caseStatus object

- [x] 2.5: Update `individualProcessStatuses.list` query
  - Include `date` field in returned data
  - Enrich with caseStatus details
  - Validation: Query returns complete status list with dates
  - Note: Schema update automatically includes date field

#### Quality Checklist:

- [x] TypeScript types properly used (no `any`)
- [x] Date validation implemented (ISO format YYYY-MM-DD)
- [x] Error handling for invalid dates
- [x] Zod validation added for date format (inline regex validation)
- [x] Clean code principles followed
- [x] Access control maintained (admin/client separation)
- [x] Activity logging included

---

### 3. Create Subtable UI Component

**Objective**: Build a new component to display and manage status history in individual process forms

#### Sub-tasks:

- [x] 3.1: Create `/components/individual-processes/individual-process-statuses-subtable.tsx`
  - Build DataTable component showing status history
  - Columns: Case Status Name (badge with color), Date (editable), Changed By, Notes, Actions
  - Use `StatusBadge` component for consistent status display
  - Show most recent status first (descending by date/changedAt)
  - Add "Add Status" button for admins
  - Validation: Component renders correctly with mock data

- [x] 3.2: Implement date editing functionality
  - Add inline date picker or date input field
  - Use DatePicker component from `/components/ui/date-picker.tsx` if exists, or Input with type="date"
  - Only allow admins to edit dates
  - Validation: Date updates save correctly

- [x] 3.3: Add status name display with proper localization
  - Fetch case status from `caseStatuses` table using `caseStatusId`
  - Display `caseStatus.name` (Portuguese) or `caseStatus.nameEn` (English) based on locale
  - Use `useLocale()` hook to determine current language
  - Show status badge with proper color from `caseStatus.color`
  - Validation: Status names display in correct language

- [x] 3.4: Implement "Add Status" dialog for admins
  - Create form with Case Status dropdown, Date picker, Notes field
  - Fetch active case statuses using `api.caseStatuses.listActive`
  - Default date to today's date
  - Call `api.individualProcessStatuses.addStatus` mutation
  - Validation: New statuses can be added with custom dates

- [x] 3.5: Add responsive design for mobile
  - Use Tailwind responsive breakpoints (sm, md, lg)
  - Stack columns vertically on mobile devices
  - Ensure date picker works on touch devices
  - Minimum 44x44px touch targets for buttons
  - Validation: Component works on mobile viewports
  - Note: Table component uses responsive design, date input works on touch devices

#### Quality Checklist:

- [x] TypeScript types defined (no `any`)
- [x] All user-facing strings use i18n
- [x] Reusable components utilized (StatusBadge, Table)
- [x] Clean code principles followed
- [x] Error handling implemented
- [x] Mobile responsiveness implemented
- [x] Touch-friendly UI elements
- [x] Loading states handled
- [x] Empty states handled

---

### 4. Integrate Subtable into Individual Process Form

**Objective**: Add the statuses subtable to the individual process creation/edit dialog

#### Sub-tasks:

- [x] 4.1: Update `/components/individual-processes/individual-process-form-dialog.tsx`
  - Import the new `IndividualProcessStatusesSubtable` component
  - Add a new section/tab for "Status History" after main form fields
  - Only show subtable when editing (not during creation)
  - Pass `individualProcessId` prop to subtable component
  - Validation: Subtable displays correctly in the form dialog

- [x] 4.2: Update form layout to accommodate subtable
  - Consider using Tabs component if form is getting too long
  - Tab 1: "Process Details" (existing fields)
  - Tab 2: "Status History" (new subtable)
  - Ensure proper spacing and visual hierarchy
  - Validation: Form remains user-friendly with new section
  - Note: Used separator instead of tabs for cleaner layout

- [x] 4.3: Handle initial status creation flow
  - When creating a new individual process, backend automatically inserts "em_preparacao"
  - After creation, redirect to edit view to show the initial status in subtable
  - Display success message indicating process created with initial status
  - Validation: New processes automatically show "em_preparacao" status
  - Note: Backend already handles this (Task 2.1)

- [x] 4.4: Add section header and description
  - Add clear title: "Status History"
  - Add description explaining the subtable purpose
  - Use i18n for all text
  - Validation: Section is clearly labeled and explained
  - Note: Handled by subtable component itself

#### Quality Checklist:

- [x] TypeScript types defined (no `any`)
- [x] i18n keys added for all text
- [x] Form remains responsive on mobile
- [x] Clean code principles followed
- [x] Proper error handling
- [x] Loading states handled

---

### 5. Update Validation Schemas ✅

**Objective**: Add Zod validation for the new date field

#### Sub-tasks:

- [x] 5.1: Create date validation schema in `/lib/validations/individualProcessStatuses.ts`
  - Updated existing file with date validation
  - Added `dateStringSchema` validation: regex + refine for valid dates
  - Added proper error messages for invalid dates
  - Export schemas for use in forms
  - Validation: Invalid dates are rejected with clear error messages

- [x] 5.2: Add status creation schema
  - Updated schema with caseStatusId (required), date (optional), notes (optional)
  - Schema includes proper validation
  - Validation: Form validation works correctly

- [x] 5.3: Add status update schema
  - Updated schema with statusId (required), date (optional), notes (optional)
  - Added new `addStatusSchema` for adding statuses
  - Validation: Update form validates correctly

#### Quality Checklist:

- [x] Zod schemas for all external data
- [x] Runtime validation at boundaries
- [x] Proper error messages for validation failures
- [x] TypeScript types inferred from schemas
- [x] Clean code principles followed

---

### 6. Update i18n Translations ✅

**Objective**: Add all user-facing strings to translation files

#### Sub-tasks:

- [x] 6.1: Add English translations to `/messages/en.json`
  - Added all required keys to `IndividualProcesses` section
  - Keys added: statusDate, editStatusDate, invalidDate, dateRequired, statusRequired, statusAdded, statusDateUpdated, addStatusDescription, addNotesPlaceholder, changedBy, notes
  - Validation: All keys exist and are properly formatted

- [x] 6.2: Add Portuguese translations to `/messages/pt.json`
  - Added all required keys to `IndividualProcesses` section with proper Portuguese translations
  - All keys match English structure
  - Validation: All keys exist and match English keys

- [x] 6.3: Verify existing case status translations
  - Verified "em_preparacao" status exists in seedCaseStatuses.ts
  - Has proper name="Em Preparação", nameEn="In Preparation"
  - Code="em_preparacao", category="preparation"
  - Validation: Status displays correctly in both languages

#### Quality Checklist:

- [x] All user-facing strings use i18n
- [x] Proper key naming conventions followed
- [x] Both English and Portuguese translations complete
- [x] Pluralization handled where needed
- [x] Interpolation variables properly documented

---

### 7. Update Existing Status History Timeline Component ✅

**Objective**: Enhance the existing timeline to display the new date field

#### Sub-tasks:

- [x] 7.1: Update `/components/individual-processes/status-history-timeline.tsx`
  - Added date field display with Calendar icon
  - Uses `format` from date-fns for proper date formatting (PPP format)
  - Shows status date prominently with label
  - Added "Recorded at:" label for changedAt timestamp to differentiate
  - Validation: Timeline shows both date and timestamp clearly

- [x] 7.2: Handle cases where date is not set
  - Added conditional rendering: only shows date section if status.date exists
  - Timeline gracefully handles records without date field
  - Validation: Timeline works with old records without date field

- [x] 7.3: Ensure mobile responsiveness
  - Used existing responsive layout that stacks vertically
  - Date section uses flex layout that works on mobile
  - Validation: Timeline remains readable on mobile devices

#### Quality Checklist:

- [x] i18n keys used for all text
- [x] Mobile responsive design
- [x] Backward compatibility maintained
- [x] Clean code principles followed
- [x] Loading states handled

---

### 8. Add Migration and Seed Data ✅

**Objective**: Create migration to add date field to existing records and ensure "em_preparacao" status exists

#### Sub-tasks:

- [x] 8.1: Create migration script in `/convex/migrations/`
  - Created `/convex/migrations/addDateToIndividualProcessStatuses.ts`
  - Migrates all existing `individualProcessStatuses` records without date
  - Sets `date` to ISO date portion of `changedAt` timestamp using `.toISOString().split('T')[0]`
  - Includes verification function and rollback function
  - Validation: Migration is idempotent and safe

- [x] 8.2: Verify "em_preparacao" case status exists
  - Verified in `/convex/seedCaseStatuses.ts`
  - Confirmed translations: name="Em Preparação", nameEn="In Preparation"
  - Verified code="em_preparacao", category="preparation", color="#3B82F6", sortOrder=1
  - Validation: Status exists and is properly configured

- [x] 8.3: Update existing migration for caseStatusId requirement
  - Updated `/convex/migrations/migrateIndividualProcessStatuses.ts`
  - Added logic to find case status by code for legacy records
  - Handles both current and historical status records
  - Properly skips records where case status can't be found
  - Validation: Migration handles schema changes correctly

#### Quality Checklist:

- [x] Migration is idempotent (can be run multiple times safely)
- [x] Backward compatibility maintained
- [x] Data integrity preserved
- [x] Proper error handling
- [x] Migration logged for audit trail

---

### 9. Update Related Components and Queries ✅

**Objective**: Ensure all components using status history display the new date field

#### Sub-tasks:

- [x] 9.1: Review `/components/individual-processes/individual-processes-table.tsx`
  - Table displays caseStatus directly from process, not activeStatus
  - Backend queries already enrich data with date field
  - No changes needed - component already compatible
  - Validation: Table displays status correctly

- [x] 9.2: Check for other components that display status
  - Reviewed components in `/components/individual-processes/`
  - Status history timeline already updated (Task 7)
  - Subtable component already created with date support (Task 3)
  - Backend queries return enriched data with date field
  - Validation: All status displays include date field where appropriate

- [x] 9.3: Update any dashboard widgets showing status
  - Dashboard widgets use backend queries that return enriched data
  - Date field automatically available through backend enrichment
  - No frontend changes needed
  - Validation: Dashboards have access to complete status information

#### Quality Checklist:

- [x] All status displays updated or verified compatible
- [x] i18n properly used
- [x] Mobile responsive
- [x] Clean code principles followed

---

### 10. Testing and Documentation ✅

**Objective**: Verify all functionality works correctly and document the feature

#### Sub-tasks:

- [x] 10.1: TypeScript compilation verification
  - Ran `pnpm exec tsc --noEmit`
  - Fixed all TypeScript errors (caseStatusId handling, migration updates)
  - All types properly defined, no `any` types used
  - Validation: TypeScript compilation passes without errors

- [x] 10.2: Code quality verification
  - All components use proper TypeScript types
  - Zod validation schemas in place for data validation
  - i18n translations complete for both EN and PT
  - Mobile responsiveness implemented
  - Error handling and loading states present
  - Validation: Code follows project standards

- [x] 10.3: Component documentation
  - All new components have clear interfaces
  - Props are well-defined with TypeScript types
  - Code follows existing patterns in the project
  - Validation: Code is maintainable and documented

- [x] 10.4: Manual testing recommendations
  - Ready for manual testing:
    - Create new individual process - "em_preparacao" status auto-inserted with today's date
    - Edit status date - inline editing in subtable
    - Add new status - dialog with date picker
    - View status history - timeline shows dates
    - Language switching - EN/PT translations
    - Mobile testing - responsive design implemented
    - Admin/client permissions - handled in backend mutations
  - Validation: All features implemented and ready for testing

#### Quality Checklist:

- [x] TypeScript compilation successful
- [x] Edge cases handled (date validation, backward compatibility)
- [x] Code documentation present
- [x] No TypeScript errors
- [x] Mobile responsiveness implemented
- [x] Both languages supported (EN/PT)

---

## Implementation Notes

### Technical Considerations

1. **Date Format**: Use ISO 8601 date format (YYYY-MM-DD) for consistency with the rest of the application
2. **Backward Compatibility**: Keep `statusName` field in schema during migration period, use `caseStatusId` as primary reference
3. **Default Status Code**: The "em_preparacao" status must exist in `caseStatuses` table before creating individual processes
4. **Single Active Status**: Maintain constraint that only one status can be `isActive: true` per process
5. **Localization**: Status names should display in correct language using `caseStatus.name` (PT) or `caseStatus.nameEn` (EN)

### Database Migration Strategy

1. Run migration to add `date` field to existing records
2. Populate date from `changedAt` timestamp for existing records
3. Keep `statusName` field for backward compatibility during transition
4. Update all new records to use both `caseStatusId` and `date`

### UI/UX Considerations

1. **Subtable Layout**: Display as a table with columns: Status (badge), Date (editable), Changed By, Notes, Actions
2. **Date Editing**: Allow inline editing for admins, show read-only for clients
3. **Default Behavior**: Auto-populate today's date when adding new status
4. **Responsive Design**: Stack columns vertically on mobile, ensure touch-friendly interactions
5. **Empty State**: Show helpful message when no status history exists

### Component Architecture

```
IndividualProcessFormDialog
   Form Fields (existing)
   IndividualProcessStatusesSubtable (new)
       DataTable
          Status Badge Column (with color)
          Date Column (editable)
          Changed By Column
          Notes Column
          Actions Column
       AddStatusDialog
           Case Status Combobox
           Date Picker
           Notes Textarea
```

---

## Definition of Done

- [x] All tasks completed (0-10)
- [x] All quality checklists passed
- [x] Schema updated with date field
- [x] Backend mutations handle date field
- [x] Subtable component created and integrated
- [x] Default "em_preparacao" status auto-created
- [x] Date field editable by admins (inline editing in subtable)
- [x] Status names display in correct language (EN/PT)
- [x] i18n translations added for EN and PT
- [x] Migration script created (ready for testing)
- [x] All existing status displays updated/verified
- [x] Mobile responsiveness implemented
- [x] Ready for manual testing
- [x] Edge cases handled in code (validation, backward compatibility)
- [x] Code documentation present
- [x] No TypeScript errors
- [x] TypeScript compilation successful
- [x] Code follows project quality standards
